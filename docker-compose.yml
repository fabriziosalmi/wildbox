# Wildbox Security Suite - Integration Testing Orchestrator
# Coordinates all services with shared networking for end-to-end testing
#
# ðŸš¨ SECURITY WARNING: This configuration uses default values for testing!
# ðŸ“‹ BEFORE PRODUCTION: 
#   1. Copy .env.example to .env
#   2. Generate secure random values for all secrets
#   3. Change all default passwords
#   4. Review SECURITY.md for complete security checklist
#
# See SECURITY.md for complete production security requirements

networks:
  wildbox:
    driver: bridge

services:
  # Identity Service (Authentication & Authorization)
  identity:
    build:
      context: ./open-security-identity
      dockerfile: Dockerfile
    container_name: open-security-identity
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      - DATABASE_URL=${DATABASE_URL:-postgresql+asyncpg://postgres:postgres@postgres:5432/identity}
      - REDIS_URL=${REDIS_URL:-redis://wildbox-redis:6379/0}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-please-set-jwt-secret-in-env-file}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-sk_test_set_your_stripe_key}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-whsec_set_your_webhook_secret}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY:-pk_test_set_your_publishable_key}
      - CREATE_INITIAL_ADMIN=${CREATE_INITIAL_ADMIN:-true}
      - INITIAL_ADMIN_EMAIL=${INITIAL_ADMIN_EMAIL:-admin@wildbox.security}
      - INITIAL_ADMIN_PASSWORD=${INITIAL_ADMIN_PASSWORD:-CHANGE-THIS-PASSWORD}
    depends_on:
      - postgres
      - wildbox-redis
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # API Service (Security Tools Platform)
  api:
    build:
      context: ./open-security-tools
      dockerfile: Dockerfile
    container_name: open-security-tools
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - API_KEY=${API_KEY:-wbx-set-your-secure-api-key-here}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,http://localhost:80,http://localhost}
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Data Service (Threat Intelligence & IOCs)
  data:
    build:
      context: ./open-security-data
      dockerfile: Dockerfile
    container_name: open-security-data
    restart: unless-stopped
    ports:
      - "8002:8002"
    environment:
      - DATABASE_URL=${DATA_DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/data}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,http://localhost:80,http://localhost}
    depends_on:
      - postgres
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # API Gateway (Request Routing & Security)
  gateway:
    build:
      context: ./open-security-gateway
      dockerfile: Dockerfile
    container_name: open-security-gateway
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./open-security-gateway/nginx:/etc/nginx:ro
      - ./open-security-gateway/logs:/var/log/nginx
      - ./open-security-gateway/ssl:/etc/ssl/wildbox:ro
    environment:
      - NGINX_ENVSUBST_OUTPUT_DIR=/etc/nginx
      - WILDBOX_ENV=development
      - GATEWAY_LOG_LEVEL=info
      - IDENTITY_SERVICE_URL=http://open-security-identity:8001
      - GATEWAY_INTERNAL_SECRET=integration-test-secret-2025
      - AUTH_CACHE_TTL=300
      - GATEWAY_DEBUG=${GATEWAY_DEBUG:-false}
    networks:
      - wildbox
    depends_on:
      - wildbox-redis
      - identity
      - data
      - guardian
      - responder
      - agents
      - cspm
      - sensor
      - automations
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Dashboard (Frontend)
  dashboard:
    build:
      context: ./open-security-dashboard
      dockerfile: Dockerfile.dev
    container_name: open-security-dashboard
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./open-security-dashboard:/app
      - /app/node_modules
      - /app/.next
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - NEXT_PUBLIC_DEBUG=${NEXT_PUBLIC_DEBUG:-false}
      - NEXT_PUBLIC_USE_GATEWAY=true
      - NEXT_PUBLIC_GATEWAY_URL=http://localhost:80
      - NEXT_PUBLIC_API_BASE_URL=http://localhost:80/api/v1/tools
      - NEXT_PUBLIC_IDENTITY_API_URL=http://localhost:80/api/v1/identity
      - NEXT_PUBLIC_DATA_API_URL=http://localhost:80/api/v1/data
      - NEXT_PUBLIC_GUARDIAN_API_URL=http://localhost:80/api/v1/guardian
      - NEXT_PUBLIC_SENSOR_API_URL=http://localhost:80/api/v1/sensor
      - NEXT_PUBLIC_RESPONDER_API_URL=http://localhost:80/api/v1/responder
      - NEXT_PUBLIC_AGENTS_API_URL=http://localhost:80/api/v1/agents
      - NEXT_PUBLIC_CSPM_API_URL=http://localhost:80/api/v1/cspm
      # Internal URLs for server-side requests within Docker network
      - INTERNAL_GATEWAY_URL=http://open-security-gateway:80
      - NEXTAUTH_SECRET=wildbox-dashboard-secret-for-testing
      - NEXTAUTH_URL=http://localhost:3000
    networks:
      wildbox:
        aliases:
          - dashboard
    depends_on:
      - gateway
      - identity

  # PostgreSQL Database (Identity Service)
  postgres:
    image: postgres:15
    container_name: wildbox-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-CHANGE-THIS-DB-PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-identity}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - wildbox
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Shared Redis Cache (Consolidated for all services)
  wildbox-redis:
    image: redis:7-alpine
    container_name: wildbox-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru --databases 16
    volumes:
      - wildbox_redis_data:/data
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3


  # Guardian Service (Security Monitoring)
  guardian:
    build:
      context: ./open-security-guardian
      dockerfile: Dockerfile
    container_name: open-security-guardian
    restart: unless-stopped
    ports:
      - "8013:8013"
    environment:
      - DATABASE_URL=${GUARDIAN_DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/guardian}
      - REDIS_URL=${GUARDIAN_REDIS_URL:-redis://wildbox-redis:6379/1}
      - CELERY_BROKER_URL=${GUARDIAN_CELERY_BROKER_URL:-redis://wildbox-redis:6379/1}
      - CELERY_RESULT_BACKEND=${GUARDIAN_CELERY_RESULT_BACKEND:-redis://wildbox-redis:6379/1}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FILE=/app/logs/guardian.log
      - ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0,open-security-guardian
    volumes:
      - guardian_logs:/app/logs
    depends_on:
      - postgres
      - wildbox-redis
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8013/health"]
      interval: 30s
      timeout: 10s
      retries: 3



  # Responder Service (Incident Response)
  responder:
    build:
      context: ./open-security-responder
      dockerfile: Dockerfile
    container_name: open-security-responder
    restart: unless-stopped
    ports:
      - "8018:8018"
    environment:
      - DATABASE_URL=${RESPONDER_DATABASE_URL:-postgresql+asyncpg://postgres:postgres@postgres:5432/responder}
      - REDIS_URL=${RESPONDER_REDIS_URL:-redis://wildbox-redis:6379/2}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      - postgres
      - wildbox-redis
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8018/health"]
      interval: 30s
      timeout: 10s
      retries: 3



  # CSPM Service (Cloud Security Posture Management)
  cspm:
    build:
      context: ./open-security-cspm
      dockerfile: Dockerfile
    container_name: open-security-cspm
    restart: unless-stopped
    ports:
      - "8019:8019"
    environment:
      - REDIS_URL=${CSPM_REDIS_URL:-redis://wildbox-redis:6379/3}
      - CELERY_BROKER_URL=${CSPM_CELERY_BROKER_URL:-redis://wildbox-redis:6379/3}
      - CELERY_RESULT_BACKEND=${CSMP_CELERY_RESULT_BACKEND:-redis://wildbox-redis:6379/3}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      - wildbox-redis
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8019/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # CSPM Celery Worker (Background Tasks)
  cspm-worker:
    build:
      context: ./open-security-cspm
      dockerfile: Dockerfile
    container_name: open-security-cspm-worker
    restart: unless-stopped
    command: celery -A app.worker worker --loglevel=info --concurrency=4
    environment:
      - REDIS_URL=redis://wildbox-redis:6379/3
      - CELERY_BROKER_URL=redis://wildbox-redis:6379/3
      - CELERY_RESULT_BACKEND=redis://wildbox-redis:6379/3
      - LOG_LEVEL=INFO
    depends_on:
      - wildbox-redis
    networks:
      - wildbox



  # Agents Service (Security Agents)
  agents:
    build:
      context: ./open-security-agents
      dockerfile: Dockerfile
    container_name: open-security-agents
    restart: unless-stopped
    ports:
      - "8006:8006"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-sk-test-dummy-key-for-development-only}
      - REDIS_URL=${AGENTS_REDIS_URL:-redis://wildbox-redis:6379/4}
      - CELERY_BROKER_URL=${AGENTS_CELERY_BROKER_URL:-redis://wildbox-redis:6379/4}
      - CELERY_RESULT_BACKEND=${AGENTS_CELERY_RESULT_BACKEND:-redis://wildbox-redis:6379/4}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      - wildbox-redis
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Agents Celery Worker (AI Processing Tasks)
  agents-worker:
    build:
      context: ./open-security-agents
      dockerfile: Dockerfile
    container_name: open-security-agents-worker
    restart: unless-stopped
    command: celery -A app.worker worker --loglevel=info --concurrency=4
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY:-sk-test-dummy-key-for-development-only}
      - REDIS_URL=${AGENTS_REDIS_URL:-redis://wildbox-redis:6379/4}
      - CELERY_BROKER_URL=${AGENTS_CELERY_BROKER_URL:-redis://wildbox-redis:6379/4}
      - CELERY_RESULT_BACKEND=${AGENTS_CELERY_RESULT_BACKEND:-redis://wildbox-redis:6379/4}
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      - wildbox-redis
    networks:
      - wildbox



  # Sensor Service (System Monitoring)
  sensor:
    build:
      context: ./open-security-sensor
      dockerfile: Dockerfile
    container_name: open-security-sensor
    restart: unless-stopped
    ports:
      - "8004:8004"
    environment:
      - SENSOR_LOGGING_LEVEL=${SENSOR_LOGGING_LEVEL:-INFO}
      - PYTHONPATH=/app
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./open-security-sensor/config.yaml.example:/etc/security-sensor/config.yaml:ro
      - sensor_logs:/var/log/security-sensor
      - sensor_data:/var/lib/security-sensor
      # Host monitoring (required for system telemetry)
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc:/host/etc:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Automations Service (n8n workflow automation)
  automations:
    image: n8nio/n8n:latest
    container_name: open-security-automations
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=wildbox_n8n_2025
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - GENERIC_TIMEZONE=UTC
      - N8N_LOG_LEVEL=info
      - WEBHOOK_URL=http://localhost:5678
      - DB_TYPE=sqlite
      - DB_SQLITE_DATABASE=/home/node/.n8n/database.sqlite
      - N8N_SECURE_COOKIE=false
      - N8N_METRICS=true
    volumes:
      - ./open-security-automations/n8n-data:/home/node/.n8n
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
  wildbox_redis_data:
  guardian_logs:
  sensor_logs:
  sensor_data:
