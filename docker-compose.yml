# Wildbox Security Suite - Integration Testing Orchestrator
# Coordinates all services with shared networking for end-to-end testing

networks:
  wildbox:
    driver: bridge

services:
  # Identity Service (Authentication & Authorization)
  identity:
    build:
      context: ./open-security-identity
      dockerfile: Dockerfile
    container_name: open-security-identity
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@postgres:5432/identity
      - REDIS_URL=redis://identity-redis:6379/0
      - JWT_SECRET_KEY=wildbox-super-secret-jwt-key-for-testing
      - STRIPE_SECRET_KEY=sk_test_dummy_key_for_testing
      - STRIPE_WEBHOOK_SECRET=whsec_dummy_webhook_for_testing
      - STRIPE_PUBLISHABLE_KEY=pk_test_dummy_publishable_for_testing
    depends_on:
      - postgres
      - identity-redis
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # API Service (Security Tools Platform)
  api:
    build:
      context: ./open-security-api
      dockerfile: Dockerfile
    container_name: open-security-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - API_KEY=wildbox-api-key-for-integration-testing-2025-secure
      - DEBUG=true
      - LOG_LEVEL=INFO
      - ENVIRONMENT=development
      - CORS_ORIGINS=http://localhost:3000,http://localhost:80,http://localhost
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Data Service (Threat Intelligence & IOCs)
  data:
    build:
      context: ./open-security-data
      dockerfile: Dockerfile
    container_name: open-security-data
    restart: unless-stopped
    ports:
      - "8002:8002"
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/data
      - DEBUG=true
      - LOG_LEVEL=INFO
      - CORS_ORIGINS=http://localhost:3000,http://localhost:80,http://localhost
    depends_on:
      - postgres
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # API Gateway (Request Routing & Security)
  gateway:
    build:
      context: ./open-security-gateway
      dockerfile: Dockerfile
    container_name: open-security-gateway
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./open-security-gateway/nginx:/etc/nginx:ro
      - ./open-security-gateway/logs:/var/log/nginx
      - ./open-security-gateway/ssl:/etc/ssl/wildbox:ro
    environment:
      - NGINX_ENVSUBST_OUTPUT_DIR=/etc/nginx
      - WILDBOX_ENV=development
      - GATEWAY_LOG_LEVEL=info
      - IDENTITY_SERVICE_URL=http://open-security-identity:8001
      - GATEWAY_INTERNAL_SECRET=integration-test-secret-2025
      - AUTH_CACHE_TTL=300
      - GATEWAY_DEBUG=true
    networks:
      - wildbox
    depends_on:
      - gateway-redis
      - identity
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Dashboard (Frontend)
  dashboard:
    build:
      context: ./open-security-dashboard
      dockerfile: Dockerfile.dev
    container_name: open-security-dashboard
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./open-security-dashboard:/app
      - /app/node_modules
      - /app/.next
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_DEBUG=true
      - NEXT_PUBLIC_API_BASE_URL=http://localhost:80
      - NEXT_PUBLIC_IDENTITY_API_URL=http://localhost:8001
      - NEXT_PUBLIC_DATA_API_URL=http://localhost:8002
      - NEXT_PUBLIC_GUARDIAN_API_URL=http://localhost:8003
      - NEXT_PUBLIC_SENSOR_API_URL=http://localhost:8004
      - NEXT_PUBLIC_RESPONDER_API_URL=http://localhost:8005
      - NEXT_PUBLIC_AGENTS_API_URL=http://localhost:8006
      - NEXTAUTH_SECRET=wildbox-dashboard-secret-for-testing
      - NEXTAUTH_URL=http://localhost:3000
    networks:
      - wildbox
    depends_on:
      - gateway
      - identity

  # PostgreSQL Database (Identity Service)
  postgres:
    image: postgres:15
    container_name: wildbox-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=identity
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - wildbox
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Redis Cache (Identity Service)
  identity-redis:
    image: redis:7-alpine
    container_name: wildbox-identity-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - identity_redis_data:/data
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis Cache (Gateway Service)
  gateway-redis:
    image: redis:7-alpine
    container_name: wildbox-gateway-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - gateway_redis_data:/data
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Guardian Service (Security Monitoring)
  guardian:
    build:
      context: ./open-security-guardian
      dockerfile: Dockerfile
    container_name: open-security-guardian
    restart: unless-stopped
    ports:
      - "8003:8003"
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@postgres:5432/guardian
      - REDIS_URL=redis://guardian-redis:6379/0
      - DEBUG=true
      - LOG_LEVEL=INFO
    depends_on:
      - postgres
      - guardian-redis
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis Cache (Guardian Service)
  guardian-redis:
    image: redis:7-alpine
    container_name: wildbox-guardian-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - guardian_redis_data:/data
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Responder Service (Incident Response)
  responder:
    build:
      context: ./open-security-responder
      dockerfile: Dockerfile
    container_name: open-security-responder
    restart: unless-stopped
    ports:
      - "8005:8005"
    environment:
      - DATABASE_URL=postgresql+asyncpg://postgres:postgres@postgres:5432/responder
      - REDIS_URL=redis://responder-redis:6379/0
      - DEBUG=true
      - LOG_LEVEL=INFO
    depends_on:
      - postgres
      - responder-redis
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis Cache (Responder Service)
  responder-redis:
    image: redis:7-alpine
    container_name: wildbox-responder-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - responder_redis_data:/data
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # CSPM Service (Cloud Security Posture Management)
  cspm:
    build:
      context: ./open-security-cspm
      dockerfile: Dockerfile
    container_name: open-security-cspm
    restart: unless-stopped
    ports:
      - "8007:8007"
    environment:
      - REDIS_URL=redis://cspm-redis:6379/0
      - DEBUG=true
      - LOG_LEVEL=INFO
    depends_on:
      - cspm-redis
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8007/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis Cache (CSPM Service)
  cspm-redis:
    image: redis:7-alpine
    container_name: wildbox-cspm-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - cspm_redis_data:/data
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Agents Service (Security Agents)
  agents:
    build:
      context: ./open-security-agents
      dockerfile: Dockerfile
    container_name: open-security-agents
    restart: unless-stopped
    ports:
      - "8006:8006"
    environment:
      - REDIS_URL=redis://agents-redis:6379/0
      - DEBUG=true
      - LOG_LEVEL=INFO
    depends_on:
      - agents-redis
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis Cache (Agents Service)
  agents-redis:
    image: redis:7-alpine
    container_name: wildbox-agents-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - agents_redis_data:/data
    networks:
      - wildbox
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
  identity_redis_data:
  gateway_redis_data:
  guardian_redis_data:
  responder_redis_data:
  cspm_redis_data:
  agents_redis_data:
