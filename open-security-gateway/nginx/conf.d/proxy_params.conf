# Common proxy parameters for Wildbox services

proxy_http_version 1.1;
proxy_set_header Connection "";
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;

# Pass authentication headers to backend services
# These headers are set by Lua authentication in access_by_lua_block
# and must be passed through to backend services
proxy_set_header X-Wildbox-User-ID $http_x_wildbox_user_id;
proxy_set_header X-Wildbox-Team-ID $http_x_wildbox_team_id;
proxy_set_header X-Wildbox-Plan $http_x_wildbox_plan;
proxy_set_header X-Wildbox-Role $http_x_wildbox_role;

# Remove original authorization header (already validated by gateway)
# proxy_set_header Authorization "";

# Timeout settings
proxy_connect_timeout 5s;
proxy_send_timeout 60s;
proxy_read_timeout 60s;

# Buffer settings
proxy_buffering on;
proxy_buffer_size 4k;
proxy_buffers 8 4k;

# CORS headers for proxied responses - temporarily removed due to duplicates
# add_header 'Access-Control-Allow-Origin' '$cors_origin' always;
# add_header 'Access-Control-Allow-Credentials' '$cors_creds' always;
# add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range,X-Wildbox-Request-ID' always;
