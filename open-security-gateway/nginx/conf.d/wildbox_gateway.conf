# Wildbox Security Gateway - Main Configuration
# Handles routing, authentication, and load balancing for all Wildbox services

# Upstream definitions for all Wildbox microservices
upstream identity_service {
    server open-security-identity:8001 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream data_service {
    server open-security-data:8002 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# upstream cspm_service {
#     server open-security-cspm:8007 max_fails=3 fail_timeout=30s;
#     keepalive 32;
# }

upstream guardian_service {
    server open-security-guardian:8003 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream responder_service {
    server open-security-responder:8005 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream agents_service {
    server open-security-agents:8006 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

upstream dashboard_service {
    server open-security-dashboard:3000 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# upstream sensor_service {
#     server open-security-sensor:8006 max_fails=3 fail_timeout=30s;
#     keepalive 32;
# }

# upstream automations_service {
#     server open-security-automations:5678 max_fails=3 fail_timeout=30s;
#     keepalive 32;
# }

# Redirect HTTP to HTTPS
server {
    listen 80;
    server_name api.wildbox.local wildbox.local *.wildbox.local;
    
    # Health check endpoint (allow HTTP for load balancer checks)
    location /health {
        access_log off;
        return 200 '{"status":"healthy","service":"wildbox-gateway","timestamp":"$time_iso8601"}';
        add_header Content-Type application/json;
    }
    
    # Redirect all other traffic to HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# Main HTTPS server block
server {
    listen 443 ssl;
    http2 on;
    server_name api.wildbox.local wildbox.local *.wildbox.local;

    # Include CORS configuration
    include /etc/nginx/conf.d/cors_params.conf;

    # SSL Configuration
    ssl_certificate /etc/ssl/wildbox/wildbox.crt;
    ssl_certificate_key /etc/ssl/wildbox/wildbox.key;
    
    # SSL Security Settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_tickets off;
    ssl_stapling on;
    ssl_stapling_verify on;

    # Enhanced Security Headers (Blueprint Phase 1 - Gateway Hardening)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https: wss:; font-src 'self' data:; object-src 'none'; media-src 'self'; frame-src 'none';" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=(), interest-cohort=()" always;
    add_header X-Permitted-Cross-Domain-Policies "none" always;
    
    # Remove server identification
    more_clear_headers Server;
    server_tokens off;

    # HTTP Method Restrictions (Blueprint Phase 1 Requirement)
    if ($request_method !~ ^(GET|HEAD|POST|PUT|DELETE|PATCH)$ ) {
        return 405 '{"error":"method_not_allowed","message":"HTTP method not supported","allowed":["GET","HEAD","POST","PUT","DELETE","PATCH"]}';
    }

    # Global rate limiting
    limit_req zone=global burst=20 nodelay;
    limit_conn addr 20;

    # Variables for dynamic routing (initialized by Lua)
    set $wildbox_user_id "";
    set $wildbox_team_id "";
    set $wildbox_plan "";
    set $wildbox_role "";
    set $gateway_debug "false";

    # Health check endpoint (no auth required)
    location /health {
        access_log off;
        return 200 '{"status":"healthy","service":"wildbox-gateway","timestamp":"$time_iso8601","ssl":"enabled"}';
        add_header Content-Type application/json;
    }

    # CORS preflight handler for all API routes
    location ~ ^/api.*$ {
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '$cors_origin' always;
            add_header 'Access-Control-Allow-Credentials' '$cors_creds' always;
            add_header 'Access-Control-Allow-Methods' '$cors_methods' always;
            add_header 'Access-Control-Allow-Headers' '$cors_headers' always;
            add_header 'Access-Control-Max-Age' 1728000 always;
            add_header 'Content-Type' 'text/plain; charset=utf-8' always;
            add_header 'Content-Length' 0 always;
            return 204;
        }
        
        # Add CORS headers to all API responses
        add_header 'Access-Control-Allow-Origin' '$cors_origin' always;
        add_header 'Access-Control-Allow-Credentials' '$cors_creds' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range,X-Wildbox-Request-ID' always;
        
        # This location is a fallback - specific API routes are handled below
        return 404 '{"error":"endpoint_not_found","message":"The requested API endpoint does not exist"}';
        add_header Content-Type application/json;
    }

    # Public endpoints (no authentication required)
    location /public/ {
        # Serve static content or documentation
        alias /var/www/public/;
        expires 1d;
        add_header Cache-Control "public, immutable";
    }

    # Authentication endpoints (identity service, no gateway auth)
    location /auth/ {
        # Rate limiting for auth endpoints
        limit_req zone=global burst=10 nodelay;
        
        # Proxy to identity service
        proxy_pass http://identity_service/;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cache auth responses briefly
        proxy_cache wildbox_cache;
        proxy_cache_key "$scheme$request_method$host$request_uri";
        proxy_cache_valid 200 2m;
        proxy_cache_valid 401 403 404 1m;
    }

    # Dashboard (web interface)
    location / {
        # Authentication required
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        # Apply dynamic rate limiting via Lua
        access_by_lua_block {
            -- Rate limiting is handled in the auth_handler.lua
        }
        
        # Proxy to dashboard
        proxy_pass http://dashboard_service;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Pass authentication headers
        proxy_set_header X-Wildbox-User-ID $wildbox_user_id;
        proxy_set_header X-Wildbox-Team-ID $wildbox_team_id;
        proxy_set_header X-Wildbox-Plan $wildbox_plan;
        proxy_set_header X-Wildbox-Role $wildbox_role;
    }

    # API Routes - All require authentication

    # Identity Service API
    location /api/v1/identity/ {
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        proxy_pass http://identity_service/api/v1/;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Data Service API
    location /api/v1/data/ {
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        # Feature gating: Check if user's plan allows access
        access_by_lua_block {
            local plan = ngx.var.wildbox_plan
            if not plan or plan == "" then
                ngx.exit(ngx.HTTP_FORBIDDEN)
            end
        }
        
        proxy_pass http://data_service/api/v1/;
        include /etc/nginx/conf.d/proxy_params.conf;
        
        # Cache data responses
        proxy_cache wildbox_cache;
        proxy_cache_key "$scheme$request_method$host$request_uri$wildbox_team_id$wildbox_plan";
        proxy_cache_valid 200 5m;
        proxy_cache_valid 404 1m;
    }

    # CSPM Service API - DISABLED (service not running)
    # location /api/v1/cspm/ {
    #     access_by_lua_file /etc/nginx/lua/auth_handler.lua;
    #     
    #     # Feature gating: CSPM requires personal plan or higher
    #     access_by_lua_block {
    #         local plan = ngx.var.wildbox_plan
    #         if plan == "free" then
    #             ngx.exit(ngx.HTTP_PAYMENT_REQUIRED)
    #         end
    #     }
    #     
    #     proxy_pass http://cspm_service/api/v1/;
    #     include /etc/nginx/conf.d/proxy_params.conf;
    # }

    # Guardian Service API
    location /api/v1/guardian/ {
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        proxy_pass http://guardian_service/api/v1/;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Responder Service API (Business plan and higher)
    location /api/v1/responder/ {
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        # Feature gating: Responder requires business plan or higher
        access_by_lua_block {
            local plan = ngx.var.wildbox_plan
            if plan == "free" or plan == "personal" then
                ngx.exit(ngx.HTTP_PAYMENT_REQUIRED)
            end
        }
        
        proxy_pass http://responder_service/api/v1/;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Agents Service API (Enterprise plan only)
    location /api/v1/agents/ {
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        # Feature gating: Agents requires enterprise plan
        access_by_lua_block {
            local plan = ngx.var.wildbox_plan
            if plan ~= "enterprise" then
                ngx.exit(ngx.HTTP_PAYMENT_REQUIRED)
            end
        }
        
        proxy_pass http://agents_service/api/v1/;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Sensor Service API - DISABLED (service not running)
    # location /api/v1/sensor/ {
    #     access_by_lua_file /etc/nginx/lua/auth_handler.lua;
    #     
    #     proxy_pass http://sensor_service/api/v1/;
    #     include /etc/nginx/conf.d/proxy_params.conf;
    # }

    # Automations Service API (Business plan and higher) - DISABLED (service not running)
    # location /api/v1/automations/ {
    #     access_by_lua_file /etc/nginx/lua/auth_handler.lua;
    #     
    #     # Feature gating: Automations requires business plan or higher
    #     access_by_lua_block {
    #         local plan = ngx.var.wildbox_plan
    #         if plan == "free" or plan == "personal" then
    #             ngx.exit(ngx.HTTP_PAYMENT_REQUIRED)
    #         end
    #     }
    #     
    #     proxy_pass http://automations_service/;
    #     include /etc/nginx/conf.d/proxy_params.conf;
    # }

    # WebSocket endpoints for real-time features
    location /ws/ {
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        proxy_pass http://dashboard_service;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Pass authentication headers
        proxy_set_header X-Wildbox-User-ID $wildbox_user_id;
        proxy_set_header X-Wildbox-Team-ID $wildbox_team_id;
        proxy_set_header X-Wildbox-Plan $wildbox_plan;
        proxy_set_header X-Wildbox-Role $wildbox_role;
        
        proxy_read_timeout 86400;
    }

    # Catch-all for undefined routes
    location ~ ^/api/ {
        return 404 '{"error":"endpoint_not_found","message":"The requested API endpoint does not exist"}';
        add_header Content-Type application/json;
    }
}
