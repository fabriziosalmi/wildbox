# Wildbox Security Gateway - Main Configuration
# Handles routing, authentication, and load balancing for all Wildbox services

# Upstream definitions for all Wildbox microservices
# Using resolver to handle dynamic service discovery
resolver 127.0.0.11 valid=30s;

upstream identity_service {
    server open-security-identity:8001 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:8001 backup down;
    keepalive 32;
}

upstream data_service {
    server open-security-data:8002 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:8002 backup down;
    keepalive 32;
}

upstream cspm_service {
    server open-security-cspm:8007 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:8007 backup down;
    keepalive 32;
}

upstream guardian_service {
    server open-security-guardian:8013 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:8013 backup down;
    keepalive 32;
}

upstream responder_service {
    server open-security-responder:8005 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:8005 backup down;
    keepalive 32;
}

upstream agents_service {
    server open-security-agents:8006 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:8006 backup down;
    keepalive 32;
}

upstream api_service {
    server open-security-api:8000 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:8000 backup down;
    keepalive 32;
}

upstream dashboard_service {
    server dashboard:3000 max_fails=3 fail_timeout=30s;
    server host.docker.internal:3000 backup;
    keepalive 32;
}

# upstream sensor_service {
#     server open-security-sensor:8004 max_fails=3 fail_timeout=30s;
#     server 127.0.0.1:8004 backup down;
#     keepalive 32;
# }

upstream automations_service {
    server open-security-automations:5678 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:5678 backup down;
    keepalive 32;
}

# Redirect HTTP to HTTPS
server {
    listen 80;
    server_name api.wildbox.local wildbox.local *.wildbox.local;
    
    # Health check endpoint (allow HTTP for load balancer checks)
    location /health {
        access_log off;
        return 200 '{"status":"healthy","service":"wildbox-gateway","timestamp":"$time_iso8601"}';
        add_header Content-Type application/json;
    }
    
    # Authentication endpoints (identity service, no gateway auth)
    location /auth/ {
        # Proxy to identity service
        proxy_pass http://identity_service/;
        include /etc/nginx/conf.d/proxy_params.conf;
    }
    
    # API endpoints - serve over HTTP as well
    location /api/ {
        # Include Lua auth handler for authenticated endpoints
        # access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        # Route based on API path
        location ~ ^/api/v1/identity/(.*) {
            proxy_pass http://identity_service/api/v1/$1$is_args$args;
            include /etc/nginx/conf.d/proxy_params.conf;
        }
        
        location ~ ^/api/v1/data/(.*) {
            proxy_pass http://data_service/api/v1/$1$is_args$args;
            include /etc/nginx/conf.d/proxy_params.conf;
        }
        
        location ~ ^/api/v1/guardian/(.*) {
            proxy_pass http://guardian_service/api/v1/$1$is_args$args;
            include /etc/nginx/conf.d/proxy_params.conf;
        }
        
        location ~ ^/api/v1/responder/(.*) {
            proxy_pass http://responder_service/api/v1/$1$is_args$args;
            include /etc/nginx/conf.d/proxy_params.conf;
        }
        
        location ~ ^/api/v1/agents/(.*) {
            proxy_pass http://agents_service/$1$is_args$args;
            include /etc/nginx/conf.d/proxy_params.conf;
        }
        
        location ~ ^/api/v1/cspm/(.*) {
            proxy_pass http://cspm_service/$1$is_args$args;
            include /etc/nginx/conf.d/proxy_params.conf;
        }
        
        location ~ ^/api/v1/tools/(.*) {
            proxy_pass http://api_service/$1$is_args$args;
            include /etc/nginx/conf.d/proxy_params.conf;
        }
    }
    
    # Dashboard (fallback for all other requests)
    location / {
        proxy_pass http://dashboard_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }
}

# Main HTTPS server block
server {
    listen 443 ssl;
    http2 on;
    server_name api.wildbox.local wildbox.local *.wildbox.local;

    # Include CORS configuration
    include /etc/nginx/conf.d/cors_params.conf;

    # SSL Configuration
    ssl_certificate /etc/ssl/wildbox/wildbox.crt;
    ssl_certificate_key /etc/ssl/wildbox/wildbox.key;
    
    # SSL Security Settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_tickets off;
    ssl_stapling on;
    ssl_stapling_verify on;

    # Enhanced Security Headers (Blueprint Phase 1 - Gateway Hardening)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https: wss:; font-src 'self' data:; object-src 'none'; media-src 'self'; frame-src 'none';" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=(), interest-cohort=()" always;
    add_header X-Permitted-Cross-Domain-Policies "none" always;
    
    # Remove server identification
    more_clear_headers Server;
    server_tokens off;

    # HTTP Method Restrictions (Blueprint Phase 1 Requirement)
    if ($request_method !~ ^(GET|HEAD|POST|PUT|DELETE|PATCH)$ ) {
        return 405 '{"error":"method_not_allowed","message":"HTTP method not supported","allowed":["GET","HEAD","POST","PUT","DELETE","PATCH"]}';
    }

    # Global rate limiting (temporarily disabled)
    # limit_req zone=global burst=20 nodelay;
    # limit_conn addr 20;

    # Variables for dynamic routing (initialized by Lua)
    set $wildbox_user_id "";
    set $wildbox_team_id "";
    set $wildbox_plan "";
    set $wildbox_role "";
    set $gateway_debug "false";

    # Health check endpoint (no auth required)
    location /health {
        access_log off;
        return 200 '{"status":"healthy","service":"wildbox-gateway","timestamp":"$time_iso8601","ssl":"enabled"}';
        add_header Content-Type application/json;
    }

    # CORS preflight handler for all API routes (temporarily disabled)
    # location ~ ^/api.*$ {
    #     if ($request_method = 'OPTIONS') {
    #         add_header 'Access-Control-Allow-Origin' '$cors_origin' always;
    #         add_header 'Access-Control-Allow-Credentials' '$cors_creds' always;
    #         add_header 'Access-Control-Allow-Methods' '$cors_methods' always;
    #         add_header 'Access-Control-Allow-Headers' '$cors_headers' always;
    #         add_header 'Access-Control-Max-Age' 1728000 always;
    #         add_header 'Content-Type' 'text/plain; charset=utf-8' always;
    #         add_header 'Content-Length' 0 always;
    #         return 204;
    #     }
    #     
    #     # This location is a fallback - specific API routes are handled below
    #     return 404 '{"error":"endpoint_not_found","message":"The requested API endpoint does not exist"}';
    #     add_header Content-Type application/json;
    # }

    # Public endpoints (no authentication required)
    location /public/ {
        # Serve static content or documentation
        alias /var/www/public/;
        expires 1d;
        add_header Cache-Control "public, immutable";
    }

    # Authentication endpoints (identity service, no gateway auth)
    location /auth/ {
        # Rate limiting for auth endpoints (temporarily disabled)
        # limit_req zone=global burst=10 nodelay;
        
        # Proxy to identity service
        proxy_pass http://identity_service/;
        include /etc/nginx/conf.d/proxy_params.conf;
        
        # Cache auth responses briefly (temporarily disabled)
        # proxy_cache wildbox_cache;
        # proxy_cache_key "$scheme$request_method$host$request_uri";
        # proxy_cache_valid 200 2m;
        # proxy_cache_valid 401 403 404 1m;
    }

    # Dashboard (web interface)
    location / {
        # Authentication required (includes rate limiting)
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        # Proxy to dashboard
        proxy_pass http://dashboard_service;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # API Routes - All require authentication

    # Identity Service API
    location /api/v1/identity/ {
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        proxy_pass http://identity_service/api/v1/;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Data Service API
    location /api/v1/data/ {
        # Authentication required (includes feature gating)
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        proxy_pass http://data_service/api/v1/;
        include /etc/nginx/conf.d/proxy_params.conf;
        
        # Cache data responses (temporarily disabled)
        # proxy_cache wildbox_cache;
        # proxy_cache_key "$scheme$request_method$host$request_uri$wildbox_team_id$wildbox_plan";
        # proxy_cache_valid 200 5m;
        # proxy_cache_valid 404 1m;
    }

    # CSPM Service API
    location /api/v1/cspm/ {
        # Authentication required (includes plan validation)
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        proxy_pass http://cspm_service/api/v1/;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Guardian Service API
    location /api/v1/guardian/ {
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        proxy_pass http://guardian_service/api/v1/;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Responder Service API (Business plan and higher)
    location /api/v1/responder/ {
        # Authentication required (includes plan validation)
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        proxy_pass http://responder_service/api/v1/;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Agents Service API (Enterprise plan only)
    location /api/v1/agents/ {
        # Authentication required (includes plan validation)
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        proxy_pass http://agents_service/api/v1/;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # Security Tools API (available to all authenticated users)
    location /api/tools/ {
        # Authentication required
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        proxy_pass http://api_service/api/tools/;
        include /etc/nginx/conf.d/proxy_params.conf;
    }
    
    # Security Tools Web Interface (available to all authenticated users)
    location /tools/ {
        # Authentication required
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        proxy_pass http://api_service/tools/;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # # Sensor Service API (commented out due to sensor startup issues)
    # location /api/v1/sensor/ {
    #     access_by_lua_file /etc/nginx/lua/auth_handler.lua;
    #     
    #     proxy_pass http://sensor_service/api/v1/;
    #     include /etc/nginx/conf.d/proxy_params.conf;
    # }

    # Automations Service API (Business plan and higher)
    location /api/v1/automations/ {
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        # Feature gating: Automations requires business plan or higher
        
        proxy_pass http://automations_service/;
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # WebSocket endpoints for real-time features
    location /ws/ {
        access_by_lua_file /etc/nginx/lua/auth_handler.lua;
        
        proxy_pass http://dashboard_service;
        include /etc/nginx/conf.d/proxy_params.conf;
        
        # Override for WebSocket
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
    }

    # Catch-all for undefined routes
    location ~ ^/api/ {
        return 404 '{"error":"endpoint_not_found","message":"The requested API endpoint does not exist"}';
        add_header Content-Type application/json;
    }
}
