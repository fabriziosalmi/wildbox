# HAProxy configuration for Blue/Green deployments
#
# Features:
# - Health check-based routing
# - Stats dashboard on :8404
# - Graceful draining of old environment
# - SSL termination

global
    log stdout format raw local0
    maxconn 4096
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms
    
    # Health check defaults
    option  httpchk GET /health HTTP/1.1
    http-check expect status 200

# Stats dashboard
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 5s
    stats show-legends
    stats show-node

# Frontend (all incoming traffic)
frontend http_front
    bind *:80
    default_backend wildbox_services

# Backend (service routing)
backend wildbox_services
    balance roundrobin
    
    # Identity service (active: blue)
    server identity-blue identity-blue:8001 check inter 2000 rise 2 fall 3
    # server identity-green identity-green:8001 check inter 2000 rise 2 fall 3 backup
    
    # Guardian service (active: blue)
    server guardian-blue guardian-blue:8013 check inter 2000 rise 2 fall 3
    # server guardian-green guardian-green:8013 check inter 2000 rise 2 fall 3 backup
    
    # Data service (active: blue)
    server data-blue data-blue:8002 check inter 2000 rise 2 fall 3
    # server data-green data-green:8002 check inter 2000 rise 2 fall 3 backup
    
    # Tools service (active: blue)
    server tools-blue tools-blue:8000 check inter 2000 rise 2 fall 3
    # server tools-green tools-green:8000 check inter 2000 rise 2 fall 3 backup
    
    # Agents service (active: blue)
    server agents-blue agents-blue:8006 check inter 2000 rise 2 fall 3
    # server agents-green agents-green:8006 check inter 2000 rise 2 fall 3 backup

# Health check endpoints
backend identity_health
    server identity-blue identity-blue:8001 check
    server identity-green identity-green:8001 check backup

backend guardian_health
    server guardian-blue guardian-blue:8013 check
    server guardian-green guardian-green:8013 check backup
